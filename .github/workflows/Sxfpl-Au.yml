name: Sxfpl Australian ðŸŽ¯

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  update-au-live:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Generate Australia Live playlist (Network wise)
        env:
          IPTV_USER: ${{ secrets.IPTV_USER }}
          IPTV_PASS: ${{ secrets.IPTV_PASS }}
        run: |
          python << 'EOF'
          import os, re, requests
          from datetime import datetime, timedelta, timezone

          # ---------------- CONFIG ----------------
          HOST_URL = "https://dhoomtv.xyz:443"
          USERNAME = "P4B9TB9xR8"
          PASSWORD = "humongous2tonight"


          OUTPUT_DIR = "Sxfpl"
          OUTPUT_FILE = f"{OUTPUT_DIR}/Au.m3u"

          DEFAULT_LOGO = "https://i.postimg.cc/MZftPYPB/IMG-20250710-192112-387.jpg"

          if not USERNAME or not PASSWORD:
              raise SystemExit("IPTV credentials not set")

          os.makedirs(OUTPUT_DIR, exist_ok=True)

          PLAYLIST_URL = (
              f"{HOST_URL}/get.php?"
              f"username={USERNAME}&password={PASSWORD}"
              "&type=m3u_plus&output=ts"
          )

          # ---------------- HELPERS ----------------
          def is_australia(line):
              return re.search(r'group-title="[^"]*australia[^"]*"', line, re.I)

          def is_live(url, line):
              return "/live/" in url.lower() or url.lower().endswith(".ts") or "live" in line.lower()

          def detect_network(name):
              n = name.upper()
              if "ABC" in n:
                  return "ABC"
              if "SBS" in n:
                  return "SBS"
              if "SEVEN" in n or re.search(r'\b7\b', n):
                  return "SEVEN"
              if "NINE" in n or re.search(r'\b9\b', n):
                  return "NINE"
              if "TEN" in n or re.search(r'\b10\b', n):
                  return "TEN"
              if "FOX" in n:
                  return "FOX"
              return "OTHER"

          def set_group(meta, network):
              meta = re.sub(r'group-title=".*?"', '', meta)
              return f'{meta} group-title="AU | {network}"'

          def load_old_urls(path):
              if not os.path.exists(path):
                  return set()
              with open(path, "r", encoding="utf-8") as f:
                  return {line.strip() for line in f if line.startswith("http")}

          # ---------------- LOAD OLD DATA ----------------
          old_urls = load_old_urls(OUTPUT_FILE)

          # ---------------- FETCH ----------------
          r = requests.get(PLAYLIST_URL, timeout=30)
          r.raise_for_status()
          lines = r.text.splitlines()

          items = []
          new_urls = set()

          for i in range(len(lines)):
              if not lines[i].startswith("#EXTINF"):
                  continue
              if not is_australia(lines[i]):
                  continue
              if i + 1 >= len(lines):
                  continue

              url = lines[i + 1].strip()
              if not is_live(url, lines[i]):
                  continue

              line = re.sub(r'(tvg-name|group-title)=".*?"', '', lines[i])
              meta, name = line.rsplit(",", 1)

              if 'tvg-logo=' not in meta:
                  meta += f' tvg-logo="{DEFAULT_LOGO}"'

              name_clean = " ".join(name.replace("_", " ").replace("-", " ").split()).title()
              network = detect_network(name_clean)

              meta = set_group(" ".join(meta.split()), network)

              items.append((f"{meta},{name_clean}", url))
              new_urls.add(url)

          # ---------------- STATS ----------------
          total_channels = len(new_urls)
          updated_channels = len(new_urls - old_urls)

          now = datetime.now(timezone.utc) + timedelta(hours=5, minutes=30)
          updated_time = now.strftime("%Y-%m-%d %H:%M IST")

          # ---------------- SAVE (HEADERS UNCHANGED) ----------------
          header = [
              '#EXTM3U billed-msg="AU Live - Made for Sidhant"',
              "# Scripted & Updated by Kittujk",
              f"# Channels : Total - {total_channels} | Updated - {updated_channels}",
              f"# Last Updated : {updated_time}",
              ""
          ]

          with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
              f.write("\n".join(header + [x for item in items for x in item]))

          print(f"Generated {OUTPUT_FILE} | Total={total_channels} | Updated={updated_channels}")
          EOF

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Sxfpl/Au.m3u
          git commit -m "Update AU Live playlist (Network wise)" || echo "No changes"
          git push
